import os
import torch
from PIL import Image
from diffusers import FluxKontextPipeline
from diffusers.utils import load_image

# --- 配置区域 ---
INPUT_DIR = "./input_frames"
OUTPUT_DIR = "./output_kontext"
MODEL_ID = "black-forest-labs/FLUX.1-Kontext-dev"

# 核心指令：这不再是描述画面，而是“下命令”
# 针对您的伪纹理场景，我们尝试以下几种指令风格
EDIT_INSTRUCTION = "Denoise the image, remove digital artifacts, and improve skin texture quality."

# Guidance Scale (引导系数)
# 官方示例用了 2.5。
# 对于去噪任务，建议在 2.0 - 3.5 之间尝试。
# 太低：指令不生效（噪点去不掉）。
# 太高：可能过度平滑或改变非目标区域。
GUIDANCE_SCALE = 2.5 

# --- 初始化 ---
print(f"正在加载 FLUX.1 Kontext [dev] ...")
# 注意：Kontext 需要从 git 安装的 diffusers 加载
pipe = FluxKontextPipeline.from_pretrained(
    MODEL_ID, 
    torch_dtype=torch.bfloat16
)

# 显存优化
pipe.enable_model_cpu_offload()

os.makedirs(OUTPUT_DIR, exist_ok=True)

def process_images():
    valid_exts = {'.jpg', '.jpeg', '.png', '.webp'}
    files = [f for f in os.listdir(INPUT_DIR) if os.path.splitext(f)[1].lower() in valid_exts]
    
    print(f"开始处理 {len(files)} 张图片")
    print(f"指令: {EDIT_INSTRUCTION}")
    print(f"Guidance Scale: {GUIDANCE_SCALE}")
    
    for filename in files:
        img_path = os.path.join(INPUT_DIR, filename)
        save_path = os.path.join(OUTPUT_DIR, filename)
        
        try:
            # 1. 加载图片
            input_image = load_image(img_path)
            
            # FLUX 仍然建议输入尺寸为 16 的倍数
            w, h = input_image.size
            new_w = w - (w % 16)
            new_h = h - (h % 16)
            if new_w != w or new_h != h:
                input_image = input_image.resize((new_w, new_h), Image.LANCZOS)
            
            # 2. 执行编辑
            # num_inference_steps 默认为 28-30 左右即可
            result = pipe(
                image=input_image,
                prompt=EDIT_INSTRUCTION,
                guidance_scale=GUIDANCE_SCALE,
                num_inference_steps=28,
                generator=torch.Generator("cpu").manual_seed(42)
            ).images[0]
            
            # 3. 保存
            result.save(save_path, quality=95)
            print(f"[完成] {filename}")
            
        except Exception as e:
            print(f"[失败] {filename}: {e}")

if __name__ == "__main__":
    process_images()
