from PIL import Image, ImageOps
import os

def fix_image_orientation(input_folder, output_folder):
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)

    valid_extensions = {'.jpg', '.jpeg', '.png', '.bmp', '.webp'}

    for filename in os.listdir(input_folder):
        ext = os.path.splitext(filename)[1].lower()
        if ext not in valid_extensions:
            continue

        input_path = os.path.join(input_folder, filename)
        output_path = os.path.join(output_folder, filename)

        try:
            image = Image.open(input_path)
            
            # 核心步骤：根据 EXIF 信息自动旋转图片并移除 EXIF 标签
            # 如果图片没有 EXIF 或不需要旋转，它会保持原样
            fixed_image = ImageOps.exif_transpose(image)
            
            # 保存处理后的图片
            # quality=95 保证 JPG 质量，根据需要调整
            fixed_image.save(output_path, quality=95)
            print(f"Processed: {filename}")
            
        except Exception as e:
            print(f"Error processing {filename}: {e}")

# 使用示例
# 替换为你的实际路径
input_dir = "./raw_images"
output_dir = "./fixed_images"

fix_image_orientation(input_dir, output_dir)
